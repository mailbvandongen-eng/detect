{"version":3,"file":"ArcadeExpression-DPAzd5S3.js","sources":["../../node_modules/@arcgis/core/support/ArcadeExpression.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{ArcadeDate as e}from\"../arcade/ArcadeDate.js\";import t from\"../core/Error.js\";import\"../core/has.js\";import{DateOnly as r}from\"../core/sql/DateOnly.js\";import{TimeOnly as i}from\"../core/sql/TimeOnly.js\";import{fromJSON as n}from\"../geometry/support/jsonUtils.js\";import s from\"../layers/support/FieldsIndex.js\";import{loadArcade as a}from\"./loadArcade.js\";import{unknown as o,system as c}from\"../time/constants.js\";const l=[\"geometry\",\"scale\",\"timeProperties\"];function u(e,t){if(null!=t)for(const r of l)t.hasArcadeDependency(r)&&e.add(r);return e}function d(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function h(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function m(e,t,r){return p.create(e,t,r,[\"$feature\",\"$view\",\"$config\"])}class p{static async create(e,r,i,n){const{arcade:s,Dictionary:o}=await a();let c;try{c=s.parseScript(e)}catch(f){throw new t(\"arcade-bad-expression\",\"Failed to parse arcade script\",{script:e,error:f})}const l=s.scriptUsesGeometryEngine(c);l&&await s.enableGeometrySupport(),await s.loadDependentModules(new Set,c,null,!1,l);const u={vars:n.reduce((e,t)=>({...e,[t]:null}),{}),spatialReference:r,useAsync:!1},d=s.compileScript(c,u);let h=null;null!=i&&(h=new o(i),h.immutable=!0);const m=new o;return m.immutable=!1,m.setField(\"scale\",0),new p(e,s,c,d,r,m,h,o)}constructor(e,t,r,i,n,s,a,o){this.script=e,this._arcade=t,this._syntaxTree=r,this._compiled=i,this._spatialReference=n,this._viewDict=s,this._configDict=a,this._dictionaryCtor=o,this._dependencies=new Map,this._featureReader=new f,this._dependencies.set(\"geometry\",t.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set(\"scale\",this._arcade.referencesMember(this._syntaxTree,\"scale\")),this._dependencies.set(\"timeProperties\",this._arcade.scriptUsesViewProperties(this._syntaxTree,[\"timeProperties\"]))}evaluate(t,r){const i=r.$view?.timeZone;if(r.$view){let t;if(this._viewDict.setField(\"scale\",r.$view.scale),null!=r.$view.timeProperties){const{currentStart:n,currentEnd:s}=r.$view.timeProperties;t=new this._dictionaryCtor({currentStart:null!=n?null!=i?e.epochToArcadeDate(n,i):e.unknownEpochToArcadeDate(n):void 0,currentEnd:null!=s?null!=i?e.epochToArcadeDate(s,i):e.unknownEpochToArcadeDate(s):void 0,startIncluded:!0,endIncluded:!0})}this._viewDict.setField(\"timeProperties\",t)}return this._compiled({vars:{$view:this._viewDict,$config:this._configDict,$feature:t},spatialReference:this._spatialReference,timeZone:i})}repurposeFeature(e,t){return this._featureReader.bind(e,t,this._spatialReference),this._featureReader}references(e){return this._dependencies.get(e)??!1}}class f{constructor(){this._boundTarget=null,this._boundSchema={fields:null,fieldsIndex:null,spatialReference:null,get geometryType(){return null},get objectIdField(){return null}},this.arcadeDeclaredClass=\"esri.arcade.Feature\",this._contextTimeZone=null}bind(e,t,r){const i=t??new s(_(e.attributes));this._boundTarget=e,this._boundSchema.fields=i.fields,this._boundSchema.fieldsIndex=i,this._boundSchema.spatialReference=r}_getField(e){return this._boundSchema.fieldsIndex.get(e)}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this._boundSchema.fieldsIndex.has(e)}geometry(){if(\"fromJSON\"in this._boundTarget)return this._boundTarget.geometry;const e=n(this._boundTarget.geometry);if(e){if(!this._boundSchema.spatialReference)throw new Error(\"InternalError: Expected spatial reference to be defined\");e.spatialReference=this._boundSchema.spatialReference}return e}_hasGeometry(){return null!=this._boundTarget.geometry}isUnknownDateTimeField(e){return this._boundSchema.fieldsIndex.getTimeZone(e)===o}field(t,n=!0){const s=this._getField(t);if(s){const n=this._boundTarget.attributes[s.name];if(null==n)return null;switch(s.type){case\"date-only\":case\"esriFieldTypeDateOnly\":return r.fromReader(n);case\"time-only\":case\"esriFieldTypeTimeOnly\":return i.fromReader(n);case\"esriFieldTypeTimestampOffset\":case\"timestamp-offset\":return e.fromReaderAsTimeStampOffset(n);case\"date\":case\"esriFieldTypeDate\":return this.isUnknownDateTimeField(t)?e.unknownEpochToArcadeDate(n):e.epochToArcadeDate(n,this.contextTimeZone??c);default:return n}}if(n)throw new Error(`Field ${t} does not exist`);return null}setField(e,t){throw new Error(\"Unable to update feature attribute values, feature is readonly\")}keys(){return this._boundSchema.fieldsIndex.fields.map(e=>e.name)}isEmpty(){return this._boundSchema.fields.length<=0&&!this._hasGeometry()}castToText(e=!1){return JSON.stringify(this._boundTarget)}gdbVersion(){return null}fullSchema(){return this._boundSchema}castAsJson(e=null){return{attributes:this._boundTarget.attributes,geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}}function _(e){const t=[];for(const r in e)t.push({name:r,alias:r,type:\"string\"==typeof e[r]?\"esriFieldTypeString\":\"esriFieldTypeDouble\"});return t}export{p as ArcadeExpression,f as ArcadeFeatureReader,u as collectExpressionDependencies,m as createDictionaryExpression,d as createLabelExpression,h as createRendererExpression,_ as deriveFields};\n"],"names":["l","u","e","t","r","h","p","m","n","s","o","a","c","f","d","i","_"],"mappings":"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","x_google_ignoreList":[0]}