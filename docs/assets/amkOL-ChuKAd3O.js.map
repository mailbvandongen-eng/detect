{"version":3,"file":"amkOL-ChuKAd3O.js","sources":["../../src/layers/amkOL.ts"],"sourcesContent":["/**\r\n * AMK Monumenten Layer for OpenLayers\r\n * RCE Archeologische Monumentenkaart with full local data (13,010 monumenten)\r\n * Data includes: toponiem, kwaliteitswaarde, txt_label, omschrijving\r\n *\r\n * Period-specific layers filter based on txt_label field:\r\n * - Romeins: contains \"Romeinse tijd\"\r\n * - Steentijd: contains \"Paleolithicum\", \"Mesolithicum\", or \"Neolithicum\"\r\n * - Vroege ME: contains \"Middeleeuwen vroeg\"\r\n * - Late ME: contains \"Middeleeuwen laat\" but NOT \"Middeleeuwen vroeg\"\r\n * - Overig: everything else\r\n *\r\n * Exception: if both Romeins AND Vroege ME are mentioned, feature appears in BOTH\r\n */\r\n\r\nimport { Vector as VectorLayer } from 'ol/layer'\r\nimport { Vector as VectorSource } from 'ol/source'\r\nimport { Style, Fill, Stroke } from 'ol/style'\r\nimport { loadTopoJSON, parseGeoJSON } from '../utils/layerLoaderOL.js'\r\nimport type { Feature } from 'ol'\r\nimport { getCenter } from 'ol/extent'\r\nimport { transform } from 'ol/proj'\r\nimport { useMonumentFilterStore, featureMatchesFilter } from '../store/monumentFilterStore'\r\n\r\n// AMK color scheme (RCE official colors)\r\nconst AMK_COLORS: Record<string, string> = {\r\n  'archeologische waarde': '#c4b5fd',\r\n  'hoge archeologische waarde': '#8b5cf6',\r\n  'zeer hoge archeologische waarde': '#6d28d9'\r\n}\r\n\r\n// Period-specific colors\r\nconst PERIOD_COLORS = {\r\n  romeins: '#ef4444',      // red\r\n  steentijd: '#f59e0b',    // amber\r\n  vroegeME: '#22c55e',     // green\r\n  lateME: '#3b82f6',       // blue\r\n  overig: '#8b5cf6'        // purple (default AMK)\r\n}\r\n\r\n// Check if txt_label indicates Romeinse tijd\r\nfunction isRomeins(txtLabel: string): boolean {\r\n  return /romeinse tijd/i.test(txtLabel)\r\n}\r\n\r\n// Check if txt_label indicates Steentijd (Paleo, Meso, Neo)\r\nfunction isSteentijd(txtLabel: string): boolean {\r\n  return /paleolithicum|mesolithicum|neolithicum/i.test(txtLabel)\r\n}\r\n\r\n// Check if txt_label indicates Vroege Middeleeuwen\r\nfunction isVroegeME(txtLabel: string): boolean {\r\n  return /middeleeuwen vroeg/i.test(txtLabel)\r\n}\r\n\r\n// Check if txt_label indicates Late Middeleeuwen (but not Vroege)\r\nfunction isLateME(txtLabel: string): boolean {\r\n  return /middeleeuwen laat/i.test(txtLabel) && !/middeleeuwen vroeg/i.test(txtLabel)\r\n}\r\n\r\n// Cached data to avoid reloading\r\nlet cachedFeatures: Feature[] | null = null\r\n\r\nasync function loadAMKData(): Promise<Feature[]> {\r\n  if (cachedFeatures) return cachedFeatures\r\n\r\n  const geojson = await loadTopoJSON('/detect/data/amk_monumenten_full.topojson')\r\n  cachedFeatures = parseGeoJSON(geojson)\r\n  return cachedFeatures\r\n}\r\n\r\n// Original AMK layer with all monuments\r\nexport async function createAMKLayerOL() {\r\n  try {\r\n    const features = await loadAMKData()\r\n\r\n    // Update total count in filter store\r\n    useMonumentFilterStore.getState().updateCounts(features.length, features.length)\r\n\r\n    const layer = new VectorLayer({\r\n      title: 'AMK Monumenten',\r\n      source: new VectorSource({ features }),\r\n      style: (feature) => {\r\n        // Check filter state\r\n        const filterState = useMonumentFilterStore.getState()\r\n\r\n        if (filterState.isActive && (filterState.keyword.length >= 2 || filterState.province !== 'all')) {\r\n          // Get feature properties\r\n          const omschrijving = feature.get('omschrijving') || ''\r\n          const toponiem = feature.get('toponiem') || ''\r\n          const txtLabel = feature.get('txt_label') || ''\r\n\r\n          // Get coordinates for province check\r\n          const geometry = feature.getGeometry()\r\n          let lng = 5.5, lat = 52.0 // Default center of NL\r\n          if (geometry) {\r\n            const center = getCenter(geometry.getExtent())\r\n            const lonLat = transform(center, 'EPSG:3857', 'EPSG:4326')\r\n            lng = lonLat[0]\r\n            lat = lonLat[1]\r\n          }\r\n\r\n          // Check if feature matches filter\r\n          const matches = featureMatchesFilter(\r\n            omschrijving,\r\n            toponiem,\r\n            txtLabel,\r\n            lng,\r\n            lat,\r\n            filterState.keyword,\r\n            filterState.province\r\n          )\r\n\r\n          if (!matches) {\r\n            return null // Hide feature\r\n          }\r\n        }\r\n\r\n        const waarde = (feature.get('kwaliteitswaarde') || '').trim()\r\n        const color = AMK_COLORS[waarde] || '#ddd'\r\n\r\n        return new Style({\r\n          fill: new Fill({ color: color }),\r\n          stroke: new Stroke({ color: color, width: 1.1 })\r\n        })\r\n      },\r\n      opacity: 0.45,\r\n      zIndex: 10\r\n    })\r\n\r\n    // Subscribe to filter changes to update count and refresh layer\r\n    // Track previous values to avoid infinite loop\r\n    let prevKeyword = ''\r\n    let prevIsActive = false\r\n\r\n    useMonumentFilterStore.subscribe((state) => {\r\n      // Only recalculate if keyword or isActive changed (not when counts change)\r\n      if (state.keyword === prevKeyword && state.isActive === prevIsActive) {\r\n        return\r\n      }\r\n      prevKeyword = state.keyword\r\n      prevIsActive = state.isActive\r\n\r\n      // Force layer to re-render with new styles\r\n      layer.changed()\r\n\r\n      if (state.isActive && state.keyword.length >= 2) {\r\n        // Count matching features\r\n        let matchCount = 0\r\n        features.forEach(feature => {\r\n          const omschrijving = feature.get('omschrijving') || ''\r\n          const toponiem = feature.get('toponiem') || ''\r\n          const txtLabel = feature.get('txt_label') || ''\r\n\r\n          const geometry = feature.getGeometry()\r\n          let lng = 5.5, lat = 52.0\r\n          if (geometry) {\r\n            const center = getCenter(geometry.getExtent())\r\n            const lonLat = transform(center, 'EPSG:3857', 'EPSG:4326')\r\n            lng = lonLat[0]\r\n            lat = lonLat[1]\r\n          }\r\n\r\n          if (featureMatchesFilter(omschrijving, toponiem, txtLabel, lng, lat, state.keyword, state.province)) {\r\n            matchCount++\r\n          }\r\n        })\r\n        useMonumentFilterStore.getState().updateCounts(features.length, matchCount)\r\n      } else {\r\n        useMonumentFilterStore.getState().updateCounts(features.length, features.length)\r\n      }\r\n    })\r\n\r\n    console.log(`✓ AMK Monumenten loaded (${features.length} features)`)\r\n    return layer\r\n\r\n  } catch (error) {\r\n    console.error('Failed to load AMK layer:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n// Helper to create a filtered AMK layer\r\nasync function createFilteredAMKLayer(\r\n  title: string,\r\n  filterFn: (txtLabel: string) => boolean,\r\n  color: string\r\n) {\r\n  try {\r\n    const allFeatures = await loadAMKData()\r\n\r\n    // Clone features that match the filter\r\n    const filteredFeatures = allFeatures.filter(feature => {\r\n      const txtLabel = feature.get('txt_label') || ''\r\n      return filterFn(txtLabel)\r\n    }).map(feature => feature.clone())\r\n\r\n    const layer = new VectorLayer({\r\n      title,\r\n      source: new VectorSource({ features: filteredFeatures }),\r\n      style: (feature) => {\r\n        const waarde = (feature.get('kwaliteitswaarde') || '').trim()\r\n        // Use period color with opacity based on quality\r\n        const opacity = waarde === 'zeer hoge archeologische waarde' ? 0.9 :\r\n                       waarde === 'hoge archeologische waarde' ? 0.7 : 0.5\r\n\r\n        return new Style({\r\n          fill: new Fill({ color: color + Math.round(opacity * 255).toString(16).padStart(2, '0') }),\r\n          stroke: new Stroke({ color: color, width: 1.5 })\r\n        })\r\n      },\r\n      opacity: 0.6,\r\n      zIndex: 11\r\n    })\r\n\r\n    console.log(`✓ ${title} loaded (${filteredFeatures.length} features)`)\r\n    return layer\r\n\r\n  } catch (error) {\r\n    console.error(`Failed to load ${title}:`, error)\r\n    return null\r\n  }\r\n}\r\n\r\n// Romeinse tijd monuments\r\nexport async function createAMKRomeinsLayerOL() {\r\n  return createFilteredAMKLayer(\r\n    'AMK Romeins',\r\n    isRomeins,\r\n    PERIOD_COLORS.romeins\r\n  )\r\n}\r\n\r\n// Steentijd monuments (Paleolithicum, Mesolithicum, Neolithicum)\r\nexport async function createAMKSteentijdLayerOL() {\r\n  return createFilteredAMKLayer(\r\n    'AMK Steentijd',\r\n    isSteentijd,\r\n    PERIOD_COLORS.steentijd\r\n  )\r\n}\r\n\r\n// Vroege Middeleeuwen monuments\r\nexport async function createAMKVroegeMELayerOL() {\r\n  return createFilteredAMKLayer(\r\n    'AMK Vroege ME',\r\n    isVroegeME,\r\n    PERIOD_COLORS.vroegeME\r\n  )\r\n}\r\n\r\n// Late Middeleeuwen monuments (excluding those that also have Vroege ME)\r\nexport async function createAMKLateMELayerOL() {\r\n  return createFilteredAMKLayer(\r\n    'AMK Late ME',\r\n    isLateME,\r\n    PERIOD_COLORS.lateME\r\n  )\r\n}\r\n\r\n// Overig - everything that doesn't match above categories\r\nexport async function createAMKOverigLayerOL() {\r\n  return createFilteredAMKLayer(\r\n    'AMK Overig',\r\n    (txtLabel) => !isRomeins(txtLabel) && !isSteentijd(txtLabel) && !isVroegeME(txtLabel) && !isLateME(txtLabel),\r\n    PERIOD_COLORS.overig\r\n  )\r\n}\r\n"],"names":["AMK_COLORS","PERIOD_COLORS","isRomeins","txtLabel","isSteentijd","isVroegeME","isLateME","cachedFeatures","loadAMKData","geojson","loadTopoJSON","parseGeoJSON","createAMKLayerOL","features","useMonumentFilterStore","layer","VectorLayer","VectorSource","feature","filterState","omschrijving","toponiem","geometry","lng","lat","center","getCenter","lonLat","transform","featureMatchesFilter","waarde","color","Style","Fill","Stroke","prevKeyword","prevIsActive","state","matchCount","error","createFilteredAMKLayer","title","filterFn","filteredFeatures","opacity","createAMKRomeinsLayerOL","createAMKSteentijdLayerOL","createAMKVroegeMELayerOL","createAMKLateMELayerOL","createAMKOverigLayerOL"],"mappings":"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"}