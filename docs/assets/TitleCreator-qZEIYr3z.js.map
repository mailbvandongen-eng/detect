{"version":3,"mappings":"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","names":["p","u","f","h","t","i","d","__vitePreload","r","s","o","l","n","c","a","e"],"ignoreList":[0],"sources":["../../node_modules/@arcgis/core/layers/support/TitleCreator.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{__decorate as e}from\"tslib\";import t from\"../../core/Accessor.js\";import{isSome as s}from\"../../core/arrayUtils.js\";import{createTask as i}from\"../../core/asyncUtils.js\";import r from\"../../core/Collection.js\";import{stripHTMLSanitizer as a}from\"../../core/sanitizerUtils.js\";import{property as o}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/Logger.js\";import{subclass as l}from\"../../core/accessorSupport/decorators/subclass.js\";import{featureHasFields as n,extractSubstitutionTemplatesFromString as c}from\"./fieldUtils.js\";import{loadArcade as d}from\"../../support/loadArcade.js\";const p=\"relationships/\",u=\"expression/\",f=/<br\\s*\\/*>/gi;let h=class extends t{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){if(this.expressionsUsedInTitle.length>0){return this._get(\"_arcadeTask\")||i(()=>d())}return null}get featureUtilsPromise(){return this._get(\"featureUtilsPromise\")??import(\"../../widgets/Feature/support/featureUtils.js\").then(e=>this._featureUtils=e)}get calculatedExpressions(){const e=new r;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const s=this._arcadeTask.value.arcade.parseScript(t.expression,[\"$layer\",\"$map\",\"$datastore\"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:\"any\"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??\"\";return\"string\"!=typeof e?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter(t=>e.includes(`{expression/${t.name.toLowerCase()}}`))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>!0===e.invalid)}get requiredFields(){const e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(const s of this.calculatedExpressions?.toArray()??[])try{const t=this._arcadeTask.value.arcade.extractFieldLiterals(s.syntax);for(const s of t){const t=s.split(\".\"),i=this.fieldsIndex.get(t.at(-1)??\"\");i&&e.add(i.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const s of t){const t=this.fieldsIndex.get(s);t&&e.add(t.name)}return null!=this.objectIdField&&e.add(this.objectIdField),e}get titleFromDisplayField(){let e=\"\";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??\"\"),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??\"\"),e?`{${e}}`:\"\"}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:\"\";return\"\"===e||null==e||this.hasBadExpressions||\"string\"!=typeof e?this.titleFromDisplayField:e}async getTitle(e,t,s){const i=t.getObjectId()??t.attributes[e.objectIdField];return(await this.getTitles(e,[t],s)).get(i)??\"\"}async getTitles(e,t,s){const i=new Map,r=s?.timeZone??\"system\";try{const[{substituteFieldsInLinksAndAttributes:o}]=await Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);s?.fetchMissingFields&&(t=await this._checkAndReQueryGraphics(e,t));const{fieldInfoMap:l,workingTitle:n}=this,c=n&&l;t.forEach(t=>{const d=t.getObjectId()??t.attributes[e.objectIdField];let p=c?o({attributes:t.attributes,expressionAttributes:null,fieldInfoMap:l,globalAttributes:this._createFormattedAttributes(e,t,r).global,layer:e,text:n}):\"\";s?.removeHTML&&(p=a.sanitize(p).replaceAll(f,\" \")),i.set(d,p)})}catch{}return i}async _checkAndReQueryGraphics(e,t){const i=t.map(t=>t.getObjectId()??t.attributes[e.objectIdField]).filter(s);if(i.length!==t.length)return t;if(t.some(e=>!n(e,this.requiredFields))){const s=e.createQuery();s.where=\"1=1\",s.outFields=[...this.requiredFields],s.objectIds=i;const r=await e.queryFeatures(s);if(r?.features.length===t.length)return r.features}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const e=this.fieldsIndex.get(s.fieldName),i=e?.name??s.fieldName;s.fieldName=i,t.set(i.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s=\"system\"){const i=this.effectivePopupTemplate?.fieldInfos??[],r={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){const s=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const e of this.calculatedExpressions)try{r[`expression/${e.name}`]=e.func({vars:{$feature:s}})}catch{}}const a={...t.attributes,...r};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:a,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return c(e).filter(e=>!(e.startsWith(p)||e.startsWith(u)))}};e([o({readOnly:!0})],h.prototype,\"_arcadeTask\",null),e([o()],h.prototype,\"_featureUtils\",void 0),e([o({readOnly:!0})],h.prototype,\"featureUtilsPromise\",null),e([o({readOnly:!0})],h.prototype,\"calculatedExpressions\",null),e([o()],h.prototype,\"displayField\",void 0),e([o()],h.prototype,\"effectivePopupTemplate\",void 0),e([o()],h.prototype,\"expressionsUsedInTitle\",null),e([o()],h.prototype,\"fieldsIndex\",void 0),e([o()],h.prototype,\"fieldInfoMap\",null),e([o()],h.prototype,\"fields\",void 0),e([o()],h.prototype,\"objectIdField\",void 0),e([o()],h.prototype,\"requiredFields\",null),h=e([l(\"esri.layers.support.TitleCreator\")],h);export{h as default};\n"],"file":"TitleCreator-qZEIYr3z.js"}