{"version":3,"file":"RawBlockCache-DNaC02cb.js","sources":["../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js","../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval(()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()},this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport e from\"../../../geometry/Point.js\";import n from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as o,snapPyramid as l}from\"../rasterFunctions/rasterProjectionHelper.js\";const r=new Map,c=new n;function i(e,n,t){const o=[];return null!=n&&o.push(`sliceId=${n}`),null!=t&&o.push(`bandIds=${t.join(\",\")}`),o.length?`${e}?${o.join(\"&\")}`:e}function u(e,n){const t={extent:null,rasterInfo:n,cache:new Map},o=r.get(e);return o?(o.push(t),o.length-1):(r.set(e,[t]),0)}function a(e,n){const t=r.get(e);t&&(t[n]=null,t.some(e=>null!=e)||r.delete(e))}function f(e){r.delete(e)}function s(e,n,t){const o=r.get(e);if(!o)return null==n?c.decreaseRefCount(e,t):0;if(null==n||null==o[n])return c.decreaseRefCount(e,t);const l=o[n]?.cache,i=l?.get(t);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(t);for(let e=0;e<o.length;e++)o[e]?.cache.delete(t);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,n,t){const o=r.get(e);if(!o)return null==n?c.getBlock(e,t):null;if(null==n||null==o[n]){for(let e=0;e<o.length;e++){const n=o[e]?.cache.get(t);if(n)return n.refCount++,n.block}return c.getBlock(e,t)}const l=o[n]?.cache.get(t);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===n||!o[r])continue;const e=o[r]?.cache,l=e?.get(t);if(e&&l)return l.refCount++,e.set(t,l),l.block}return null}function h(e,n,t,o,l=null){const i=r.get(e);if(!i)return void(null==n&&c.putBlock(e,t,o,l));if(null==n||null==i[n])return void c.putBlock(e,t,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then(()=>u.isResolved=!0).catch(()=>u.isRejected=!0),i[n]?.cache.set(t,u)}function x(e,n,t){const o=r.get(e);o?null!=n&&null!=o[n]?o[n]?.cache.delete(t):c.deleteBlock(e,t):null==n&&c.deleteBlock(e,t)}function d(e,n){const t=r.get(e);return t?t[n]??null:null}function g(n,r,c,i,u,a,f=null){const s=d(n,r);if(!s)return;const m=s.extent,{cache:h,rasterInfo:x}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:p,transform:y}=x,k=new Set;for(let d=0;d<g.length;d++){const n=g[d];if(n.xmax-n.xmin<=i||n.ymax-n.ymin<=i)continue;let r=t(n,p,f);if(null==r)continue;if(null!=y&&(r=y.inverseTransform(r),null==r))continue;const c=new e({x:i,y:i,spatialReference:n.spatialReference});if(null==u&&!(u=o(c,p,n,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:h}=l(u,x,a||\"closest\");if(h)return;const{storageInfo:M}=x,{origin:R}=M,{x:C,y:B}=m,b=Math.max(0,Math.floor((r.xmin-R.x)/C)),j=Math.max(0,Math.floor((R.y-r.ymax)/B)),v=Math.ceil(r.width/C-.1),w=Math.ceil(r.height/B-.1),$=s>0?M.pyramidBlockWidth:M.blockWidth,I=s>0?M.pyramidBlockHeight:M.blockHeight,H=M.blockBoundary[s];if(!H)continue;const E=1,P=Math.max(H.minCol,Math.floor(b/$)-E),W=Math.max(H.minRow,Math.floor(j/I)-E),z=Math.min(H.maxCol,Math.floor((b+v-1)/$)+E),F=Math.min(H.maxRow,Math.floor((j+w-1)/I)+E);for(let e=W;e<=F;e++)for(let n=P;n<=z;n++)k.add(`${s}/${e}/${n}`)}h.forEach((e,n)=>{if(!k.has(n)){const e=h.get(n);(null==e||e.isResolved||e.isRejected)&&h.delete(n)}}),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,x as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,h as putBlock,u as register,a as unregister,g as update};\n"],"names":["t","e","s","r","i","c","n","o","u","a","l","m","h","x","d","g","f","p","y","k","M","R","C","B","b","j","v","w","$","I","H","E","P","W","z","F"],"mappings":"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","x_google_ignoreList":[0,1]}