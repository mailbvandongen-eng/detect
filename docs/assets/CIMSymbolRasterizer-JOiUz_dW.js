import{bC as k,au as F}from"./index-COb2Lpbg.js";import{i as T}from"./CIMResourceManager-DLjvT8_T.js";import{Y as G,a as $,m as j}from"./CIMSymbolHelper-oTacWKkt.js";import{OverrideHelper as q}from"./OverrideHelper-BGx8WNHp.js";import{T as S,R as D}from"./rasterizingUtils-Dc7MFfI7.js";import{O as z}from"./utils-DQaLv0i_.js";import"./BidiEngine-BvER9tXK.js";import"./labelPoint-Dka3Fs9G.js";import"./OptimizedFeature-BXYMv9qN.js";import"./memoryEstimations-lIi-rmuZ.js";import"./GeometryUtils-BVMNF2qq.js";import"./defaultCIMValues-XI-Li77m.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BT9q2wcW.js";import"./defaults-CWnQF4Sj.js";import"./defaultsJSON-GKolV7NZ.js";import"./colorUtils-BfQsRJR2.js";import"./vec42-DCvKWz6U.js";import"./vec4f64-DPb6J-GU.js";import"./FieldsIndex-CnKZsF7K.js";import"./UnknownTimeZone-DVqZ7rzk.js";import"./ArcadeExpression-Bd5ron0w.js";import"./TimeOnly-BzU17Qrv.js";import"./enum-BFFwfnHN.js";import"./callExpressionWithFeature-DIxboVxW.js";import"./quantizationUtils-D7S2Cd8J.js";const A=96/72;class pt{constructor(o){this._spatialReference=o,this._imageDataCanvas=null,this._cimResourceManager=new T}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(o,n,m,M,I,s,c,l,p,x){if(!o)return null;const{data:d}=o;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:v}=d;s||(s=z(v));const a=await q.resolveSymbolOverrides(d,n,this._spatialReference,I,s,c,l),w=this._cimResourceManager,b=[];G.fetchResources(a,w,b),G.fetchFonts(a,w,b),b.length>0&&await Promise.all(b);const{width:e,height:r}=m;let y=E(s,e,r,M,x);const t=G.getEnvelope(a,y,w);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-r/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=r);let g=1,_=0,R=0;switch(v.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let h=1;t.height>r&&(h=r/t.height),M==="preview"&&(t.width<e&&(i=e/t.width),t.height<r&&(h=r/t.height)),g=Math.min(i,h),_=t.x+t.width/2,R=t.y+t.height/2}break;case"CIMLineSymbol":if(x){R=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:S(y.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{(p||t.height>r)&&(g=r/t.height),R=t.y+t.height/2;const i=t.x*g+e/2,h=(t.x+t.width)*g+e/2,C=k(y)?y.paths:F(y)?y.rings:null;if(C===null)throw new Error("Bad geometry, can't rasterise symbol!");C[0][0][0]-=i/g,C[0][2][0]-=(h-e)/g}break;case"CIMPolygonSymbol":if(x){R=t.y+t.height/2,_=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:S(y.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{_=t.x+t.width/2,R=t.y+t.height/2;const i=t.x*g+e/2,h=(t.x+t.width)*g+e/2,C=t.y*g+r/2,P=(t.y+t.height)*g+r/2,{rings:u}=y;i<0&&(u[0][0][0]-=i,u[0][3][0]-=i,u[0][4][0]-=i),C<0&&(u[0][0][1]+=C,u[0][1][1]+=C,u[0][4][1]+=C),h>e&&(u[0][1][0]-=h-e,u[0][2][0]-=h-e),P>r&&(u[0][2][1]+=P-r,u[0][3][1]+=P-r)}}const O={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(O,e,r,_,R,g,s,1,y)}rasterize(o,n,m,M,I,s,c,l=0,p=null,x=window.devicePixelRatio||1){const{data:d}=o;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:v}=d,a=this._canvas,w=x*A;a.width=n*w,a.height=m*w,c||(c=z(v)),p||(p=E(c,n,m,"legend")),a.width+=2*l,a.height+=2*l;const b=a.getContext("2d",{willReadFrequently:!0}),e=$.createIdentity();return e.translate(-M,-I),e.scale(s*w,-s*w),e.translate(n*w/2+l,m*w/2+l),b.clearRect(0,0,a.width,a.height),new j(b,this._cimResourceManager,e,!0).drawSymbol(v,p),b.getImageData(0,0,a.width,a.height)}}function B(f,o,n,m){return o==="esriGeometryPolygon"?{rings:D(S(f.rings,{xmin:0,ymin:0,width:n,height:m}),-1*n/2,-1*m/2)}:o==="esriGeometryPolyline"?{paths:D(S(f.paths,{xmin:0,ymin:0,width:n,height:m}),-1*n/2,-1*m/2)}:null}function E(f,o,n,m,M){const s=-o/2+1,c=o/2-1,l=n/2-1,p=-n/2+1;if(M&&(f==="esriGeometryPolygon"||f==="esriGeometryPolyline")){const x=B(M,f,o,n);if(x)return x}switch(f){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[c,0]]]};default:return m==="legend"?{rings:[[[s,l],[c,0],[c,p],[s,p],[s,l]]]}:{rings:[[[s,l],[c,l],[c,p],[s,p],[s,l]]]}}}export{pt as CIMSymbolRasterizer};
//# sourceMappingURL=CIMSymbolRasterizer-JOiUz_dW.js.map
