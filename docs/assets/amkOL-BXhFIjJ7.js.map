{"version":3,"file":"amkOL-BXhFIjJ7.js","sources":["../../src/layers/amkOL.ts"],"sourcesContent":["/**\n * AMK Monumenten Layer for OpenLayers\n * RCE Archeologische Monumentenkaart with full local data (13,010 monumenten)\n * Data includes: toponiem, kwaliteitswaarde, txt_label, omschrijving\n *\n * Period-specific layers filter based on txt_label field:\n * - Romeins: contains \"Romeinse tijd\"\n * - Steentijd: contains \"Paleolithicum\", \"Mesolithicum\", or \"Neolithicum\"\n * - Vroege ME: contains \"Middeleeuwen vroeg\"\n * - Late ME: contains \"Middeleeuwen laat\" but NOT \"Middeleeuwen vroeg\"\n * - Overig: everything else\n *\n * Exception: if both Romeins AND Vroege ME are mentioned, feature appears in BOTH\n */\n\nimport { Vector as VectorLayer } from 'ol/layer'\nimport { Vector as VectorSource } from 'ol/source'\nimport { Style, Fill, Stroke } from 'ol/style'\nimport { loadTopoJSON, parseGeoJSON } from '../utils/layerLoaderOL.js'\nimport type { Feature } from 'ol'\nimport { getCenter } from 'ol/extent'\nimport { transform } from 'ol/proj'\nimport { useMonumentFilterStore, featureMatchesFilter } from '../store/monumentFilterStore'\n\n// AMK color scheme (RCE official colors)\nconst AMK_COLORS: Record<string, string> = {\n  'archeologische waarde': '#c4b5fd',\n  'hoge archeologische waarde': '#8b5cf6',\n  'zeer hoge archeologische waarde': '#6d28d9'\n}\n\n// Period-specific colors\nconst PERIOD_COLORS = {\n  romeins: '#ef4444',      // red\n  steentijd: '#f59e0b',    // amber\n  vroegeME: '#22c55e',     // green\n  lateME: '#3b82f6',       // blue\n  overig: '#8b5cf6'        // purple (default AMK)\n}\n\n// Check if txt_label indicates Romeinse tijd\nfunction isRomeins(txtLabel: string): boolean {\n  return /romeinse tijd/i.test(txtLabel)\n}\n\n// Check if txt_label indicates Steentijd (Paleo, Meso, Neo)\nfunction isSteentijd(txtLabel: string): boolean {\n  return /paleolithicum|mesolithicum|neolithicum/i.test(txtLabel)\n}\n\n// Check if txt_label indicates Vroege Middeleeuwen\nfunction isVroegeME(txtLabel: string): boolean {\n  return /middeleeuwen vroeg/i.test(txtLabel)\n}\n\n// Check if txt_label indicates Late Middeleeuwen (but not Vroege)\nfunction isLateME(txtLabel: string): boolean {\n  return /middeleeuwen laat/i.test(txtLabel) && !/middeleeuwen vroeg/i.test(txtLabel)\n}\n\n// Cached data to avoid reloading\nlet cachedFeatures: Feature[] | null = null\n\nasync function loadAMKData(): Promise<Feature[]> {\n  if (cachedFeatures) return cachedFeatures\n\n  const geojson = await loadTopoJSON('/detectorapp-nl/data/amk_monumenten_full.topojson')\n  cachedFeatures = parseGeoJSON(geojson)\n  return cachedFeatures\n}\n\n// Original AMK layer with all monuments\nexport async function createAMKLayerOL() {\n  try {\n    const features = await loadAMKData()\n\n    // Update total count in filter store\n    useMonumentFilterStore.getState().updateCounts(features.length, features.length)\n\n    const layer = new VectorLayer({\n      title: 'AMK Monumenten',\n      source: new VectorSource({ features }),\n      style: (feature) => {\n        // Check filter state\n        const filterState = useMonumentFilterStore.getState()\n\n        if (filterState.isActive && (filterState.keyword.length >= 2 || filterState.province !== 'all')) {\n          // Get feature properties\n          const omschrijving = feature.get('omschrijving') || ''\n          const toponiem = feature.get('toponiem') || ''\n          const txtLabel = feature.get('txt_label') || ''\n\n          // Get coordinates for province check\n          const geometry = feature.getGeometry()\n          let lng = 5.5, lat = 52.0 // Default center of NL\n          if (geometry) {\n            const center = getCenter(geometry.getExtent())\n            const lonLat = transform(center, 'EPSG:3857', 'EPSG:4326')\n            lng = lonLat[0]\n            lat = lonLat[1]\n          }\n\n          // Check if feature matches filter\n          const matches = featureMatchesFilter(\n            omschrijving,\n            toponiem,\n            txtLabel,\n            lng,\n            lat,\n            filterState.keyword,\n            filterState.province\n          )\n\n          if (!matches) {\n            return null // Hide feature\n          }\n        }\n\n        const waarde = (feature.get('kwaliteitswaarde') || '').trim()\n        const color = AMK_COLORS[waarde] || '#ddd'\n\n        return new Style({\n          fill: new Fill({ color: color }),\n          stroke: new Stroke({ color: color, width: 1.1 })\n        })\n      },\n      opacity: 0.45,\n      zIndex: 10\n    })\n\n    // Subscribe to filter changes to update count and refresh layer\n    // Track previous values to avoid infinite loop\n    let prevKeyword = ''\n    let prevIsActive = false\n\n    useMonumentFilterStore.subscribe((state) => {\n      // Only recalculate if keyword or isActive changed (not when counts change)\n      if (state.keyword === prevKeyword && state.isActive === prevIsActive) {\n        return\n      }\n      prevKeyword = state.keyword\n      prevIsActive = state.isActive\n\n      // Force layer to re-render with new styles\n      layer.changed()\n\n      if (state.isActive && state.keyword.length >= 2) {\n        // Count matching features\n        let matchCount = 0\n        features.forEach(feature => {\n          const omschrijving = feature.get('omschrijving') || ''\n          const toponiem = feature.get('toponiem') || ''\n          const txtLabel = feature.get('txt_label') || ''\n\n          const geometry = feature.getGeometry()\n          let lng = 5.5, lat = 52.0\n          if (geometry) {\n            const center = getCenter(geometry.getExtent())\n            const lonLat = transform(center, 'EPSG:3857', 'EPSG:4326')\n            lng = lonLat[0]\n            lat = lonLat[1]\n          }\n\n          if (featureMatchesFilter(omschrijving, toponiem, txtLabel, lng, lat, state.keyword, state.province)) {\n            matchCount++\n          }\n        })\n        useMonumentFilterStore.getState().updateCounts(features.length, matchCount)\n      } else {\n        useMonumentFilterStore.getState().updateCounts(features.length, features.length)\n      }\n    })\n\n    console.log(`✓ AMK Monumenten loaded (${features.length} features)`)\n    return layer\n\n  } catch (error) {\n    console.error('Failed to load AMK layer:', error)\n    return null\n  }\n}\n\n// Helper to create a filtered AMK layer\nasync function createFilteredAMKLayer(\n  title: string,\n  filterFn: (txtLabel: string) => boolean,\n  color: string\n) {\n  try {\n    const allFeatures = await loadAMKData()\n\n    // Clone features that match the filter\n    const filteredFeatures = allFeatures.filter(feature => {\n      const txtLabel = feature.get('txt_label') || ''\n      return filterFn(txtLabel)\n    }).map(feature => feature.clone())\n\n    const layer = new VectorLayer({\n      title,\n      source: new VectorSource({ features: filteredFeatures }),\n      style: (feature) => {\n        const waarde = (feature.get('kwaliteitswaarde') || '').trim()\n        // Use period color with opacity based on quality\n        const opacity = waarde === 'zeer hoge archeologische waarde' ? 0.9 :\n                       waarde === 'hoge archeologische waarde' ? 0.7 : 0.5\n\n        return new Style({\n          fill: new Fill({ color: color + Math.round(opacity * 255).toString(16).padStart(2, '0') }),\n          stroke: new Stroke({ color: color, width: 1.5 })\n        })\n      },\n      opacity: 0.6,\n      zIndex: 11\n    })\n\n    console.log(`✓ ${title} loaded (${filteredFeatures.length} features)`)\n    return layer\n\n  } catch (error) {\n    console.error(`Failed to load ${title}:`, error)\n    return null\n  }\n}\n\n// Romeinse tijd monuments\nexport async function createAMKRomeinsLayerOL() {\n  return createFilteredAMKLayer(\n    'AMK Romeins',\n    isRomeins,\n    PERIOD_COLORS.romeins\n  )\n}\n\n// Steentijd monuments (Paleolithicum, Mesolithicum, Neolithicum)\nexport async function createAMKSteentijdLayerOL() {\n  return createFilteredAMKLayer(\n    'AMK Steentijd',\n    isSteentijd,\n    PERIOD_COLORS.steentijd\n  )\n}\n\n// Vroege Middeleeuwen monuments\nexport async function createAMKVroegeMELayerOL() {\n  return createFilteredAMKLayer(\n    'AMK Vroege ME',\n    isVroegeME,\n    PERIOD_COLORS.vroegeME\n  )\n}\n\n// Late Middeleeuwen monuments (excluding those that also have Vroege ME)\nexport async function createAMKLateMELayerOL() {\n  return createFilteredAMKLayer(\n    'AMK Late ME',\n    isLateME,\n    PERIOD_COLORS.lateME\n  )\n}\n\n// Overig - everything that doesn't match above categories\nexport async function createAMKOverigLayerOL() {\n  return createFilteredAMKLayer(\n    'AMK Overig',\n    (txtLabel) => !isRomeins(txtLabel) && !isSteentijd(txtLabel) && !isVroegeME(txtLabel) && !isLateME(txtLabel),\n    PERIOD_COLORS.overig\n  )\n}\n"],"names":["AMK_COLORS","PERIOD_COLORS","isRomeins","txtLabel","isSteentijd","isVroegeME","isLateME","cachedFeatures","loadAMKData","geojson","loadTopoJSON","parseGeoJSON","createAMKLayerOL","features","useMonumentFilterStore","layer","VectorLayer","VectorSource","feature","filterState","omschrijving","toponiem","geometry","lng","lat","center","getCenter","lonLat","transform","featureMatchesFilter","waarde","color","Style","Fill","Stroke","prevKeyword","prevIsActive","state","matchCount","error","createFilteredAMKLayer","title","filterFn","filteredFeatures","opacity","createAMKRomeinsLayerOL","createAMKSteentijdLayerOL","createAMKVroegeMELayerOL","createAMKLateMELayerOL","createAMKOverigLayerOL"],"mappings":"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"}