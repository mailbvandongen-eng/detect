{"version":3,"file":"OverrideHelper-vmzcKbQZ.js","sources":["../../node_modules/@arcgis/core/symbols/cim/OverrideHelper.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import{isRGB as r}from\"../../core/colorUtils.js\";import{clone as i}from\"../../core/lang.js\";import s from\"../../layers/support/FieldsIndex.js\";import{createRendererExpression as t}from\"../../support/ArcadeExpression.js\";import{normalizeDashEffectTemplate as o,toLowerCaseProps as a,normalizePrimitiveOverrideProps as c,attributesToFields as l,analyzeTextParts as n,assignTextValuesFromFeature as p,uncapitalize as f}from\"./utils.js\";import m from\"../../views/2d/arcade/callExpressionWithFeature.js\";const y=e=>{if(!e)return[0,0,0,0];const{r,g:i,b:s,a:t}=e;return[r,i,s,255*t]};class v{static findApplicableOverrides(e,r,i){if(e&&r){if(e.primitiveName){let s=!1;for(const r of i)if(r.primitiveName===e.primitiveName){s=!0;break}if(!s)for(const t of r)t.primitiveName===e.primitiveName&&i.push(t)}switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":if(e.effects)for(const s of e.effects)v.findApplicableOverrides(s,r,i);if(e.symbolLayers)for(const s of e.symbolLayers)v.findApplicableOverrides(s,r,i);break;case\"CIMTextSymbol\":break;case\"CIMSolidStroke\":case\"CIMPictureStroke\":case\"CIMGradientStroke\":case\"CIMSolidFill\":case\"CIMPictureFill\":case\"CIMHatchFill\":case\"CIMGradientFill\":case\"CIMVectorMarker\":case\"CIMCharacterMarker\":case\"CIMPictureMarker\":if(e.effects)for(const s of e.effects)v.findApplicableOverrides(s,r,i);if(e.markerPlacement&&v.findApplicableOverrides(e.markerPlacement,r,i),\"CIMVectorMarker\"===e.type){if(e.markerGraphics)for(const s of e.markerGraphics)v.findApplicableOverrides(s,r,i),v.findApplicableOverrides(s.symbol,r,i)}else\"CIMCharacterMarker\"===e.type?v.findApplicableOverrides(e.symbol,r,i):\"CIMHatchFill\"===e.type?v.findApplicableOverrides(e.lineSymbol,r,i):\"CIMPictureMarker\"===e.type&&v.findApplicableOverrides(e.animatedSymbolProperties,r,i)}}}static findEffectOverrides(e,r){if(!e)return null;if(\"CIMGeometricEffectDashes\"===e.type&&o(e),!r||!e.primitiveName)return{type:\"cim-effect-param\",effect:e,overrides:[]};const i=a(e),s=e.primitiveName,t=[];for(const o of r)o.primitiveName===s&&t.push(a(o));return{type:\"cim-effect-param\",effect:i,overrides:c(t)}}static async resolveSymbolOverrides(e,r,t,o,a,c,n){if(!e?.symbol)return null;let{symbol:p,primitiveOverrides:f}=e;const m=!!f;if(!m&&!o)return p;p=i(p),f=i(f);let y=!0;if(r||(r={attributes:{}},y=!1),m){if(y||(f=f.filter(e=>!e.valueExpressionInfo?.expression.includes(\"$feature\"))),n||(f=f.filter(e=>!e.valueExpressionInfo?.expression.includes(\"$view\"))),f.length>0){const e=l(r.attributes),i={spatialReference:t,fields:e,geometryType:a};await v.createRenderExpressions(f,i),v.evaluateOverrides(f,r,a??\"esriGeometryPoint\",c,n,new s(e))}v.applyOverrides(p,f)}return o&&v.applyDictionaryTextOverrides(p,r,o,null),p}static{this._expressionToRenderExpression=new Map}static async createRenderExpressions(e,r){const i=[];for(const s of e){const e=s.valueExpressionInfo;if(!e||v._expressionToRenderExpression.has(e.expression))continue;const o=t(e.expression,r.spatialReference);i.push(o),o.then(r=>v._expressionToRenderExpression.set(e.expression,r))}i.length>0&&await Promise.all(i)}static evaluateOverrides(e,i,s,t,o,a){const c={$view:{scale:o?.scale}};for(const l of e){l.value&&\"object\"==typeof l.value&&r(l.value)&&(\"Color\"===l.propertyName||\"StrokeColor\"===l.propertyName)&&(l.value=y(l.value));const e=l.valueExpressionInfo;if(!e)continue;const o=v._expressionToRenderExpression.get(e.expression);o&&(l.value=m(o,i,c,s,a,t))}}static applyDictionaryTextOverrides(e,r,i,s,t=\"Normal\"){if(e?.type)switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":case\"CIMTextSymbol\":{const o=e.symbolLayers;if(!o)return;for(const a of o)a&&\"CIMVectorMarker\"===a.type&&v.applyDictionaryTextOverrides(a,r,i,s,\"CIMTextSymbol\"===e.type?e.textCase:t)}break;case\"CIMVectorMarker\":{const t=e.markerGraphics;if(!t)return;for(const e of t)e&&v.applyDictionaryTextOverrides(e,r,i,s)}break;case\"CIMMarkerGraphic\":{const o=e.textString;if(o&&o.includes(\"[\")){const a=n(o,i);e.textString=p(r,a,s,t)}}}}static applyOverrides(e,r,i,s){if(e.primitiveName)for(const t of r)if(t.primitiveName===e.primitiveName){const r=f(t.propertyName);if(s&&s.push({cim:e,nocapPropertyName:r,value:e[r]}),i){let r=!1;for(const s of i)s.primitiveName===e.primitiveName&&(r=!0);r||i.push(t)}null!=t.value&&(e[r]=t.value)}switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":if(e.effects)for(const t of e.effects)v.applyOverrides(t,r,i,s);if(e.symbolLayers)for(const t of e.symbolLayers)v.applyOverrides(t,r,i,s);break;case\"CIMTextSymbol\":break;case\"CIMSolidStroke\":case\"CIMSolidFill\":case\"CIMVectorMarker\":if(e.effects)for(const t of e.effects)v.applyOverrides(t,r,i,s);if(\"CIMVectorMarker\"===e.type&&e.markerGraphics)for(const t of e.markerGraphics)v.applyOverrides(t,r,i,s),v.applyOverrides(t.symbol,r,i,s)}}static restoreOverrides(e){for(const r of e)r.cim[r.nocapPropertyName]=r.value}static buildOverrideKey(e){let r=\"\";for(const i of e)void 0!==i.value&&(r+=`${i.primitiveName}${i.propertyName}${JSON.stringify(i.value)}`);return r}static toValue(r,i){if(\"DashTemplate\"===r)return i.split(\" \").map(e=>Number(e));if(\"Color\"===r){const r=new e(i).toRgba();return r[3]*=255,r}return i}}export{v as OverrideHelper};\n"],"names":["y","e","r","i","s","t","_v","o","a","c","n","f","m","l","p","v"],"mappings":"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","x_google_ignoreList":[0]}