{"version":3,"file":"CIMSymbolRasterizer-DWoep-r4.js","sources":["../../node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{isPolyline as e,isPolygon as t}from\"../../geometry/support/jsonUtils.js\";import i from\"./CIMResourceManager.js\";import{Transformation as r,CanvasDrawHelper as h}from\"./CIMSymbolDrawHelper.js\";import{CIMSymbolHelper as s}from\"./CIMSymbolHelper.js\";import{OverrideHelper as n}from\"./OverrideHelper.js\";import{scale as a,translate as o}from\"./rasterizingUtils.js\";import{mapCIMSymbolToGeometryType as l}from\"./utils.js\";const m=96/72;class g{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new i}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(i,r,h,o,m,g,c,d,w,u){if(!i)return null;const{data:p}=i;if(!p||\"CIMSymbolReference\"!==p.type||!p.symbol)return null;const{symbol:f}=p;g||(g=l(f));const x=await n.resolveSymbolOverrides(p,r,this._spatialReference,m,g,c,d),b=this._cimResourceManager,M=[];s.fetchResources(x,b,M),s.fetchFonts(x,b,M),M.length>0&&await Promise.all(M);const{width:C,height:R}=h;let v=y(g,C,R,o,u);const I=s.getEnvelope(x,v,b);if(!I)return null;I.x===1/0&&(I.x=C+2),I.y===1/0&&(I.y=-R/2),I.width===-1/0&&(I.width=C),I.height===-1/0&&(I.height=R);let S=1,_=0,P=0;switch(f.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":{let e=1;I.width>C&&(e=C/I.width);let t=1;I.height>R&&(t=R/I.height),\"preview\"===o&&(I.width<C&&(e=C/I.width),I.height<R&&(t=R/I.height)),S=Math.min(e,t),_=I.x+I.width/2,P=I.y+I.height/2}break;case\"CIMLineSymbol\":if(u){P=I.y+I.height/2,_=I.x+I.width/2;const e=I.width-C,t=I.height-R;v={paths:a(v.paths,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{(w||I.height>R)&&(S=R/I.height),P=I.y+I.height/2;const i=I.x*S+C/2,r=(I.x+I.width)*S+C/2,h=e(v)?v.paths:t(v)?v.rings:null;if(null===h)throw new Error(\"Bad geometry, can't rasterise symbol!\");h[0][0][0]-=i/S,h[0][2][0]-=(r-C)/S}break;case\"CIMPolygonSymbol\":if(u){P=I.y+I.height/2,_=I.x+I.width/2;const e=I.width-C,t=I.height-R;v={paths:a(v.rings,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{_=I.x+I.width/2,P=I.y+I.height/2;const e=I.x*S+C/2,t=(I.x+I.width)*S+C/2,i=I.y*S+R/2,r=(I.y+I.height)*S+R/2,{rings:h}=v;e<0&&(h[0][0][0]-=e,h[0][3][0]-=e,h[0][4][0]-=e),i<0&&(h[0][0][1]+=i,h[0][1][1]+=i,h[0][4][1]+=i),t>C&&(h[0][1][0]-=t-C,h[0][2][0]-=t-C),r>R&&(h[0][2][1]+=r-R,h[0][3][1]+=r-R)}}const j={type:\"cim\",data:{type:\"CIMSymbolReference\",symbol:x}};return this.rasterize(j,C,R,_,P,S,g,1,v)}rasterize(e,t,i,s,n,a,o,g=0,c=null,d=window.devicePixelRatio||1){const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w,p=this._canvas,f=d*m;p.width=t*f,p.height=i*f,o||(o=l(u)),c||(c=y(o,t,i,\"legend\")),p.width+=2*g,p.height+=2*g;const x=p.getContext(\"2d\",{willReadFrequently:!0}),b=r.createIdentity();b.translate(-s,-n),b.scale(a*f,-a*f),b.translate(t*f/2+g,i*f/2+g),x.clearRect(0,0,p.width,p.height);return new h(x,this._cimResourceManager,b,!0).drawSymbol(u,c),x.getImageData(0,0,p.width,p.height)}}function c(e,t,i,r){if(\"esriGeometryPolygon\"===t){return{rings:o(a(e.rings,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}}if(\"esriGeometryPolyline\"===t){return{paths:o(a(e.paths,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}}return null}function y(e,t,i,r,h){const s=1,n=-t/2+s,a=t/2-s,o=i/2-s,l=-i/2+s;if(h&&(\"esriGeometryPolygon\"===e||\"esriGeometryPolyline\"===e)){const r=c(h,e,t,i);if(r)return r}switch(e){case\"esriGeometryPoint\":return{x:0,y:0};case\"esriGeometryPolyline\":return{paths:[[[n,0],[0,0],[a,0]]]};default:return\"legend\"===r?{rings:[[[n,o],[a,0],[a,l],[n,l],[n,o]]]}:{rings:[[[n,o],[a,o],[a,l],[n,l],[n,o]]]}}}export{g as CIMSymbolRasterizer};\n"],"names":["m","g","e","i","r","h","o","d","w","u","p","f","l","x","n","b","M","s","C","R","v","y","I","S","P","t","a","j","c"],"mappings":"6/BAIwa,MAAMA,EAAE,GAAG,GAAG,MAAMC,EAAC,CAAC,YAAYC,EAAE,CAAC,KAAK,kBAAkBA,EAAE,KAAK,iBAAiB,KAAK,KAAK,oBAAoB,IAAIC,CAAC,CAAC,IAAI,SAAS,CAAC,OAAO,KAAK,mBAAmB,KAAK,iBAAiB,SAAS,cAAc,QAAQ,GAAG,KAAK,gBAAgB,CAAC,IAAI,iBAAiB,CAAC,OAAO,KAAK,mBAAmB,CAAC,MAAM,wBAAwBA,EAAEC,EAAEC,EAAEC,EAAEN,EAAEC,EAAE,EAAEM,EAAEC,EAAEC,EAAE,CAAC,GAAG,CAACN,EAAE,OAAO,KAAK,KAAK,CAAC,KAAKO,CAAC,EAAEP,EAAE,GAAG,CAACO,GAA0BA,EAAE,OAAzB,sBAA+B,CAACA,EAAE,OAAO,OAAO,KAAK,KAAK,CAAC,OAAOC,CAAC,EAAED,EAAET,IAAIA,EAAEW,EAAED,CAAC,GAAG,MAAME,EAAE,MAAMC,EAAE,uBAAuBJ,EAAEN,EAAE,KAAK,kBAAkBJ,EAAEC,EAAE,EAAEM,CAAC,EAAEQ,EAAE,KAAK,oBAAoBC,EAAE,CAAA,EAAGC,EAAE,eAAeJ,EAAEE,EAAEC,CAAC,EAAEC,EAAE,WAAWJ,EAAEE,EAAEC,CAAC,EAAEA,EAAE,OAAO,GAAG,MAAM,QAAQ,IAAIA,CAAC,EAAE,KAAK,CAAC,MAAME,EAAE,OAAOC,CAAC,EAAEd,EAAE,IAAIe,EAAEC,EAAEpB,EAAEiB,EAAEC,EAAEb,EAAEG,CAAC,EAAE,MAAMa,EAAEL,EAAE,YAAYJ,EAAEO,EAAEL,CAAC,EAAE,GAAG,CAACO,EAAE,OAAO,KAAKA,EAAE,IAAI,MAAMA,EAAE,EAAEJ,EAAE,GAAGI,EAAE,IAAI,MAAMA,EAAE,EAAE,CAACH,EAAE,GAAGG,EAAE,QAAQ,OAAOA,EAAE,MAAMJ,GAAGI,EAAE,SAAS,OAAOA,EAAE,OAAOH,GAAG,IAAII,EAAE,EAAE,EAAE,EAAEC,EAAE,EAAE,OAAOb,EAAE,KAAI,CAAE,IAAI,iBAAiB,IAAI,gBAAgB,CAAC,IAAIT,EAAE,EAAEoB,EAAE,MAAMJ,IAAIhB,EAAEgB,EAAEI,EAAE,OAAO,IAAIG,EAAE,EAAEH,EAAE,OAAOH,IAAIM,EAAEN,EAAEG,EAAE,QAAoBhB,IAAZ,YAAgBgB,EAAE,MAAMJ,IAAIhB,EAAEgB,EAAEI,EAAE,OAAOA,EAAE,OAAOH,IAAIM,EAAEN,EAAEG,EAAE,SAASC,EAAE,KAAK,IAAIrB,EAAEuB,CAAC,EAAE,EAAEH,EAAE,EAAEA,EAAE,MAAM,EAAEE,EAAEF,EAAE,EAAEA,EAAE,OAAO,CAAC,CAAC,MAAM,IAAI,gBAAgB,GAAGb,EAAE,CAACe,EAAEF,EAAE,EAAEA,EAAE,OAAO,EAAE,EAAEA,EAAE,EAAEA,EAAE,MAAM,EAAE,MAAMpB,EAAEoB,EAAE,MAAMJ,EAAEO,EAAEH,EAAE,OAAOH,EAAEC,EAAE,CAAC,MAAMM,EAAEN,EAAE,MAAM,CAAC,KAAK,GAAGE,EAAE,MAAM,EAAEpB,EAAE,KAAKoB,EAAE,MAAM,EAAEpB,EAAE,KAAK,GAAGoB,EAAE,OAAO,EAAEG,EAAE,KAAKH,EAAE,OAAO,EAAEG,EAAE,MAAMH,EAAE,MAAM,EAAEpB,EAAE,OAAOoB,EAAE,OAAO,EAAEG,CAAC,CAAC,CAAC,CAAC,KAAK,EAAEjB,GAAGc,EAAE,OAAOH,KAAKI,EAAEJ,EAAEG,EAAE,QAAQE,EAAEF,EAAE,EAAEA,EAAE,OAAO,EAAE,MAAM,EAAEA,EAAE,EAAEC,EAAEL,EAAE,EAAEd,GAAGkB,EAAE,EAAEA,EAAE,OAAOC,EAAEL,EAAE,EAAEb,EAAEH,EAAEkB,CAAC,EAAEA,EAAE,MAAMK,EAAEL,CAAC,EAAEA,EAAE,MAAM,KAAK,GAAUf,IAAP,KAAS,MAAM,IAAI,MAAM,uCAAuC,EAAEA,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAG,EAAEkB,EAAElB,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAID,EAAEc,GAAGK,CAAC,CAAC,MAAM,IAAI,mBAAmB,GAAGd,EAAE,CAACe,EAAEF,EAAE,EAAEA,EAAE,OAAO,EAAE,EAAEA,EAAE,EAAEA,EAAE,MAAM,EAAE,MAAMpB,EAAEoB,EAAE,MAAMJ,EAAEO,EAAEH,EAAE,OAAOH,EAAEC,EAAE,CAAC,MAAMM,EAAEN,EAAE,MAAM,CAAC,KAAK,GAAGE,EAAE,MAAM,EAAEpB,EAAE,KAAKoB,EAAE,MAAM,EAAEpB,EAAE,KAAK,GAAGoB,EAAE,OAAO,EAAEG,EAAE,KAAKH,EAAE,OAAO,EAAEG,EAAE,MAAMH,EAAE,MAAM,EAAEpB,EAAE,OAAOoB,EAAE,OAAO,EAAEG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,EAAEH,EAAE,EAAEA,EAAE,MAAM,EAAEE,EAAEF,EAAE,EAAEA,EAAE,OAAO,EAAE,MAAMpB,EAAEoB,EAAE,EAAEC,EAAEL,EAAE,EAAEO,GAAGH,EAAE,EAAEA,EAAE,OAAOC,EAAEL,EAAE,EAAEf,EAAEmB,EAAE,EAAEC,EAAEJ,EAAE,EAAEf,GAAGkB,EAAE,EAAEA,EAAE,QAAQC,EAAEJ,EAAE,EAAE,CAAC,MAAMd,CAAC,EAAEe,EAAElB,EAAE,IAAIG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGH,EAAEG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGH,EAAEG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGH,GAAGC,EAAE,IAAIE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGF,EAAEE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGF,EAAEE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGF,GAAGsB,EAAEP,IAAIb,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGoB,EAAEP,EAAEb,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGoB,EAAEP,GAAGd,EAAEe,IAAId,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGD,EAAEe,EAAEd,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAGD,EAAEe,EAAE,CAAC,CAAC,MAAMQ,EAAE,CAAC,KAAK,MAAM,KAAK,CAAC,KAAK,qBAAqB,OAAOd,CAAC,CAAC,EAAE,OAAO,KAAK,UAAUc,EAAET,EAAEC,EAAE,EAAEK,EAAED,EAAEtB,EAAE,EAAEmB,CAAC,CAAC,CAAC,UAAUlB,EAAEuB,EAAEtB,EAAEc,EAAEH,EAAEY,EAAEpB,EAAEL,EAAE,EAAE2B,EAAE,KAAKrB,EAAE,OAAO,kBAAkB,EAAE,CAAC,KAAK,CAAC,KAAKC,CAAC,EAAEN,EAAE,GAAG,CAACM,GAA0BA,EAAE,OAAzB,sBAA+B,CAACA,EAAE,OAAO,OAAO,KAAK,KAAK,CAAC,OAAOC,CAAC,EAAED,EAAEE,EAAE,KAAK,QAAQC,EAAEJ,EAAEP,EAAEU,EAAE,MAAMe,EAAEd,EAAED,EAAE,OAAOP,EAAEQ,EAAEL,IAAIA,EAAEM,EAAEH,CAAC,GAAGmB,IAAIA,EAAEP,EAAEf,EAAEmB,EAAEtB,EAAE,QAAQ,GAAGO,EAAE,OAAO,EAAET,EAAES,EAAE,QAAQ,EAAET,EAAE,MAAMY,EAAEH,EAAE,WAAW,KAAK,CAAC,mBAAmB,EAAE,CAAC,EAAEK,EAAEX,EAAE,eAAc,EAAG,OAAAW,EAAE,UAAU,CAACE,EAAE,CAACH,CAAC,EAAEC,EAAE,MAAMW,EAAEf,EAAE,CAACe,EAAEf,CAAC,EAAEI,EAAE,UAAUU,EAAEd,EAAE,EAAEV,EAAEE,EAAEQ,EAAE,EAAEV,CAAC,EAAEY,EAAE,UAAU,EAAE,EAAEH,EAAE,MAAMA,EAAE,MAAM,EAAS,IAAIL,EAAEQ,EAAE,KAAK,oBAAoBE,EAAE,EAAE,EAAE,WAAWN,EAAEmB,CAAC,EAAEf,EAAE,aAAa,EAAE,EAAEH,EAAE,MAAMA,EAAE,MAAM,CAAC,CAAC,CAAC,SAASkB,EAAE1B,EAAEuB,EAAEtB,EAAEC,EAAE,CAAC,OAA2BqB,IAAxB,sBAAiC,CAAC,MAAMnB,EAAEoB,EAAExB,EAAE,MAAM,CAAC,KAAK,EAAE,KAAK,EAAE,MAAMC,EAAE,OAAOC,CAAC,CAAC,EAAE,GAAGD,EAAE,EAAE,GAAGC,EAAE,CAAC,CAAC,EAA8BqB,IAAzB,uBAAkC,CAAC,MAAMnB,EAAEoB,EAAExB,EAAE,MAAM,CAAC,KAAK,EAAE,KAAK,EAAE,MAAMC,EAAE,OAAOC,CAAC,CAAC,EAAE,GAAGD,EAAE,EAAE,GAAGC,EAAE,CAAC,CAAC,EAAS,IAAI,CAAC,SAASiB,EAAEnB,EAAEuB,EAAEtB,EAAEC,EAAEC,EAAE,CAAC,MAAUS,EAAE,CAACW,EAAE,EAAE,EAAEC,EAAED,EAAE,EAAE,EAAEnB,EAAEH,EAAE,EAAE,EAAES,EAAE,CAACT,EAAE,EAAE,EAAE,GAAGE,IAA4BH,IAAxB,uBAAoDA,IAAzB,wBAA4B,CAAC,MAAME,EAAEwB,EAAEvB,EAAEH,EAAEuB,EAAEtB,CAAC,EAAE,GAAGC,EAAE,OAAOA,CAAC,CAAC,OAAOF,EAAC,CAAE,IAAI,oBAAoB,MAAM,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,IAAI,uBAAuB,MAAM,CAAC,MAAM,CAAC,CAAC,CAACY,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAACY,EAAE,CAAC,CAAC,CAAC,CAAC,EAAE,QAAQ,OAAiBtB,IAAX,SAAa,CAAC,MAAM,CAAC,CAAC,CAACU,EAAER,CAAC,EAAE,CAACoB,EAAE,CAAC,EAAE,CAACA,EAAEd,CAAC,EAAE,CAACE,EAAEF,CAAC,EAAE,CAACE,EAAER,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAACQ,EAAER,CAAC,EAAE,CAACoB,EAAEpB,CAAC,EAAE,CAACoB,EAAEd,CAAC,EAAE,CAACE,EAAEF,CAAC,EAAE,CAACE,EAAER,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC","x_google_ignoreList":[0]}