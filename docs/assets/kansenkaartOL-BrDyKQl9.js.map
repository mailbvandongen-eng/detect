{"version":3,"file":"kansenkaartOL-BrDyKQl9.js","sources":["../../src/layers/kansenkaartOL.ts"],"sourcesContent":["/**\r\n * Kansenkaart - Predictive Archaeological Expectation Map\r\n *\r\n * Combines multiple data sources to create a weighted heatmap showing\r\n * areas with high archaeological potential based on:\r\n *\r\n * 1. LANDSCAPE (geomorfologie) - where people COULD live:\r\n *    - Stroomruggen, oeverwallen (dry elevated river areas)\r\n *    - Rivierduinen (river dunes)\r\n *    - Dekzandruggen (cover sand ridges)\r\n *    - Terpen/wierden (artificial dwelling mounds)\r\n *\r\n * 2. FINDS - where people DID live:\r\n *    - AMK Monumenten (known archaeological sites)\r\n *    - Grafheuvels (burial mounds)\r\n *    - Hunebedden (megalithic tombs)\r\n *    - Steentijd sites (prehistoric settlements)\r\n *\r\n * The edges of hotspots indicate areas likely to contain undiscovered sites.\r\n */\r\n\r\nimport { Feature } from 'ol'\r\nimport { Point } from 'ol/geom'\r\nimport { Vector as VectorSource } from 'ol/source'\r\nimport { Heatmap as HeatmapLayer } from 'ol/layer'\r\nimport GeoJSON from 'ol/format/GeoJSON'\r\nimport { fromLonLat } from 'ol/proj'\r\nimport { loadTopoJSON, parseGeoJSON } from '../utils/layerLoaderOL'\r\n\r\n// Weight configuration for different feature types\r\nconst WEIGHTS = {\r\n  // Geomorfologie - landscape potential (where people COULD live)\r\n  geomorf_zeer_hoog: 1.0,   // Stroomruggen, oeverwallen, rivierduinen, terpen\r\n  geomorf_hoog: 0.8,        // Dekzandruggen, dekzandkopjes, stuwwallen\r\n  geomorf_middel: 0.6,      // Getij-oeverwallen, strandwallen, landduinen\r\n  geomorf_laag: 0.4,        // Dekzandwelvingen, stroomrugglooiingen\r\n\r\n  // Archaeological finds (where people DID live)\r\n  amk_zeer_hoog: 1.0,       // Proven very important site\r\n  amk_hoog: 0.8,\r\n  amk_basis: 0.6,\r\n  grafheuvel: 0.8,\r\n  hunebed: 0.8,\r\n  steentijd: 0.6,\r\n  uikav: 0.6,\r\n  kasteel: 0.4,\r\n  ruine: 0.4,\r\n}\r\n\r\n// Cache for loaded data\r\nlet cachedWeightedPoints: Feature<Point>[] | null = null\r\nlet isLoading = false\r\nlet loadPromise: Promise<Feature<Point>[]> | null = null\r\n\r\n/**\r\n * Load GeoJSON file and return features\r\n */\r\nasync function loadGeoJSONFeatures(url: string): Promise<Feature[]> {\r\n  try {\r\n    const response = await fetch(url)\r\n    if (!response.ok) {\r\n      console.warn(`Kansenkaart: Could not load ${url}`)\r\n      return []\r\n    }\r\n    const geojson = await response.json()\r\n    return new GeoJSON().readFeatures(geojson, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:3857'\r\n    })\r\n  } catch (error) {\r\n    console.warn(`Kansenkaart: Error loading ${url}:`, error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Extract centroid point from any geometry type\r\n */\r\nfunction getCentroid(feature: Feature): [number, number] | null {\r\n  const geom = feature.getGeometry()\r\n  if (!geom) return null\r\n\r\n  if (geom.getType() === 'Point') {\r\n    return (geom as Point).getCoordinates() as [number, number]\r\n  }\r\n\r\n  // For polygons and other geometries, get the center of the extent\r\n  const extent = geom.getExtent()\r\n  return [\r\n    (extent[0] + extent[2]) / 2,\r\n    (extent[1] + extent[3]) / 2\r\n  ]\r\n}\r\n\r\n/**\r\n * Create a weighted point feature for the heatmap\r\n */\r\nfunction createWeightedPoint(coords: [number, number], weight: number): Feature<Point> {\r\n  const feature = new Feature({\r\n    geometry: new Point(coords),\r\n    weight: weight\r\n  })\r\n  return feature\r\n}\r\n\r\n/**\r\n * Load all data sources and create weighted point features\r\n */\r\nasync function loadAllWeightedPoints(): Promise<Feature<Point>[]> {\r\n  if (cachedWeightedPoints) return cachedWeightedPoints\r\n\r\n  // Prevent duplicate loading\r\n  if (isLoading && loadPromise) return loadPromise\r\n\r\n  isLoading = true\r\n\r\n  loadPromise = (async () => {\r\n    const weightedPoints: Feature<Point>[] = []\r\n\r\n    console.log('ðŸ—ºï¸ Kansenkaart: Loading archaeological data sources...')\r\n\r\n    // Load all data sources in parallel\r\n    const [\r\n      amkGeojson,\r\n      grafheuvelsFeatures,\r\n      hunebeddenFeatures,\r\n      steentijdFeatures,\r\n      uikavFeatures,\r\n      kastelenFeatures,\r\n      ruinesFeatures,\r\n      geomorfologieFeatures\r\n    ] = await Promise.all([\r\n      // AMK - TopoJSON\r\n      loadTopoJSON('/detect/data/amk_monumenten_full.topojson').catch(() => null),\r\n      // Grafheuvels\r\n      loadGeoJSONFeatures('/detect/data/grafheuvels.geojson'),\r\n      // Hunebedden\r\n      loadGeoJSONFeatures('/detect/data/steentijd/hunebedden.geojson'),\r\n      // EuroEVOL Steentijd sites\r\n      loadGeoJSONFeatures('/detect/data/steentijd/euroevol_nl_be.geojson'),\r\n      // UIKAV Punten\r\n      loadGeoJSONFeatures('/detect/data/uikav/uikav_archeo_punten.geojson'),\r\n      // Kastelen\r\n      loadGeoJSONFeatures('/detect/data/kastelen.geojson'),\r\n      // RuÃ¯nes\r\n      loadGeoJSONFeatures('/detect/data/ruines_osm.geojson'),\r\n      // Geomorfologie hotspots (stroomruggen, rivierduinen, dekzandruggen, etc.)\r\n      loadGeoJSONFeatures('/detect/data/geomorfologie_hotspots.geojson')\r\n    ])\r\n\r\n    // Process AMK monuments with quality-based weights\r\n    if (amkGeojson) {\r\n      const amkFeatures = parseGeoJSON(amkGeojson)\r\n      for (const feature of amkFeatures) {\r\n        const coords = getCentroid(feature)\r\n        if (!coords) continue\r\n\r\n        const quality = (feature.get('kwaliteitswaarde') || '').toLowerCase()\r\n        let weight = WEIGHTS.amk_basis\r\n\r\n        if (quality.includes('zeer hoge')) {\r\n          weight = WEIGHTS.amk_zeer_hoog\r\n        } else if (quality.includes('hoge')) {\r\n          weight = WEIGHTS.amk_hoog\r\n        }\r\n\r\n        weightedPoints.push(createWeightedPoint(coords, weight))\r\n      }\r\n      console.log(`  âœ“ AMK: ${amkFeatures.length} monumenten`)\r\n    }\r\n\r\n    // Process Grafheuvels\r\n    for (const feature of grafheuvelsFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.grafheuvel))\r\n      }\r\n    }\r\n    console.log(`  âœ“ Grafheuvels: ${grafheuvelsFeatures.length}`)\r\n\r\n    // Process Hunebedden\r\n    for (const feature of hunebeddenFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.hunebed))\r\n      }\r\n    }\r\n    console.log(`  âœ“ Hunebedden: ${hunebeddenFeatures.length}`)\r\n\r\n    // Process Steentijd sites\r\n    for (const feature of steentijdFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.steentijd))\r\n      }\r\n    }\r\n    console.log(`  âœ“ Steentijd sites: ${steentijdFeatures.length}`)\r\n\r\n    // Process UIKAV\r\n    for (const feature of uikavFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.uikav))\r\n      }\r\n    }\r\n    console.log(`  âœ“ UIKAV punten: ${uikavFeatures.length}`)\r\n\r\n    // Process Kastelen\r\n    for (const feature of kastelenFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.kasteel))\r\n      }\r\n    }\r\n    console.log(`  âœ“ Kastelen: ${kastelenFeatures.length}`)\r\n\r\n    // Process RuÃ¯nes\r\n    for (const feature of ruinesFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        weightedPoints.push(createWeightedPoint(coords, WEIGHTS.ruine))\r\n      }\r\n    }\r\n    console.log(`  âœ“ RuÃ¯nes: ${ruinesFeatures.length}`)\r\n\r\n    // Process Geomorfologie hotspots (stroomruggen, rivierduinen, dekzandruggen, etc.)\r\n    // The weight is already stored in the GeoJSON from the extraction script\r\n    for (const feature of geomorfologieFeatures) {\r\n      const coords = getCentroid(feature)\r\n      if (coords) {\r\n        // Get the pre-calculated weight from the feature properties\r\n        const featureWeight = feature.get('weight') || 0.5\r\n        weightedPoints.push(createWeightedPoint(coords, featureWeight))\r\n      }\r\n    }\r\n    console.log(`  âœ“ Geomorfologie hotspots: ${geomorfologieFeatures.length}`)\r\n\r\n    console.log(`ðŸ—ºï¸ Kansenkaart: ${weightedPoints.length} total weighted points loaded`)\r\n\r\n    cachedWeightedPoints = weightedPoints\r\n    isLoading = false\r\n    return weightedPoints\r\n  })()\r\n\r\n  return loadPromise\r\n}\r\n\r\n/**\r\n * Create the Kansenkaart heatmap layer\r\n */\r\nexport async function createKansenkaartLayerOL() {\r\n  try {\r\n    console.log('ðŸ—ºï¸ Kansenkaart: Starting layer creation...')\r\n    const weightedPoints = await loadAllWeightedPoints()\r\n    console.log(`ðŸ—ºï¸ Kansenkaart: Got ${weightedPoints.length} weighted points`)\r\n\r\n    const source = new VectorSource({\r\n      features: weightedPoints\r\n    })\r\n\r\n    const heatmapLayer = new HeatmapLayer({\r\n      source: source,\r\n      properties: {\r\n        title: 'Kansenkaart',\r\n        type: 'heatmap',\r\n        queryable: false  // No popup for heatmap\r\n      },\r\n      visible: false,\r\n      opacity: 0.6,\r\n      zIndex: 5, // Below other layers but above base map\r\n      blur: 15,   // Reduced for better performance\r\n      radius: 8,  // Reduced for better performance with many points\r\n      weight: (feature) => {\r\n        // Get the weight we stored on the feature\r\n        return feature.get('weight') || 0.5\r\n      },\r\n      // Gradient: transparent -> blue -> cyan -> green -> yellow -> orange -> red\r\n      gradient: ['rgba(0,0,255,0)', 'rgba(0,0,255,0.5)', '#00ffff', '#00ff00', '#ffff00', '#ff8800', '#ff0000']\r\n    })\r\n\r\n    console.log('âœ“ Kansenkaart heatmap layer created')\r\n    return heatmapLayer\r\n\r\n  } catch (error) {\r\n    console.error('Failed to create Kansenkaart layer:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Get statistics about loaded data\r\n */\r\nexport function getKansenkaartStats() {\r\n  return {\r\n    totalPoints: cachedWeightedPoints?.length || 0,\r\n    isLoaded: cachedWeightedPoints !== null\r\n  }\r\n}\r\n"],"names":["WEIGHTS","cachedWeightedPoints","isLoading","loadPromise","loadGeoJSONFeatures","url","response","geojson","GeoJSON","error","getCentroid","feature","geom","extent","createWeightedPoint","coords","weight","Feature","Point","loadAllWeightedPoints","weightedPoints","amkGeojson","grafheuvelsFeatures","hunebeddenFeatures","steentijdFeatures","uikavFeatures","kastelenFeatures","ruinesFeatures","geomorfologieFeatures","loadTopoJSON","amkFeatures","parseGeoJSON","quality","featureWeight","createKansenkaartLayerOL","source","VectorSource","heatmapLayer","HeatmapLayer"],"mappings":"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"}